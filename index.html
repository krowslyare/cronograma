<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma del Proyecto</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* RESET & BASE */
        html, body { height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; display: flex; flex-direction: column; overflow: hidden; }
        
        /* SCROLLBAR CUSTOMIZATION */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* LAYOUT COMPONENTS */
        .app-container { display: flex; flex-direction: column; height: 100%; padding: 1rem; box-sizing: border-box; }
        
        .gantt-wrapper { 
            display: flex; 
            flex-direction: column; 
            flex: 1; 
            border: 1px solid #cbd5e1; 
            border-radius: 0.5rem; 
            overflow: hidden; 
            background: white; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            min-height: 0; /* Critical for flex nesting */
        }

        /* ROW STRUCTURES */
        .gantt-row-header { display: flex; background-color: #f8fafc; border-bottom: 1px solid #e2e8f0; flex-shrink: 0; height: 60px; }
        .gantt-row-body { display: flex; flex: 1; overflow: hidden; min-height: 0; }
        .gantt-row-footer { display: flex; height: 16px; background-color: #f8fafc; border-top: 1px solid #e2e8f0; flex-shrink: 0; }

        /* COLUMNS */
        .col-sidebar { width: 450px; flex-shrink: 0; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; background: white; z-index: 20; }
        .col-chart { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; min-width: 0; }

        /* SIDEBAR CONTENT */
        .sidebar-title { padding: 0 1rem; height: 100%; display: flex; align-items: center; font-weight: 600; color: #334155; background: #f8fafc; }
        .sidebar-list { overflow-y: hidden; overflow-x: hidden; flex: 1; } /* Scroll is driven by JS sync */

        /* CHART CONTENT */
        .timeline-header-scroll { overflow-x: hidden; height: 100%; display: flex; align-items: center; }
        .chart-scroll-area { overflow: auto; flex: 1; position: relative; scroll-behavior: auto; } /* Auto scroll behavior for instant jumps */
        
        /* GRID & BARS */
        .grid-container { position: relative; height: 100%; } /* Width set by JS */
        .grid-bg { position: absolute; inset: 0; display: grid; pointer-events: none; z-index: 0; }
        .grid-line { border-right: 1px solid #f1f5f9; height: 100%; }
        .grid-line.weekend { background-color: #f8fafc; }
        
        .bars-layer { position: absolute; inset: 0; z-index: 10; pointer-events: none; }
        
        /* ROWS STYLING */
        .row-item { height: 40px; display: flex; align-items: center; border-bottom: 1px solid #f1f5f9; padding: 0 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; box-sizing: border-box; }
        
        /* HIERARCHY COLORS (MATCHING TAILWIND) */
        .type-phase { background-color: #f0fdfa; color: #134e4a; font-weight: 700; border-bottom: 1px solid #ccfbf1; } /* Teal-50/900 */
        .type-package { background-color: #ecfdf5; color: #047857; font-weight: 600; padding-left: 2rem; } /* Emerald-50/700 */
        .type-task { background-color: white; color: #334155; font-weight: 400; padding-left: 3.5rem; font-size: 0.875rem; } /* Slate-700 */
        .type-task strong { color: #3b82f6; margin-right: 8px; font-weight: 600; } /* Blue-500 */

        /* BARS STYLING */
        .gantt-bar { 
            position: absolute; height: 24px; top: 8px; border-radius: 4px; 
            pointer-events: auto; cursor: pointer; display: flex; align-items: center; 
            padding: 0 0.5rem; font-size: 0.75rem; color: white; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); white-space: nowrap; overflow: hidden;
            transition: transform 0.1s, opacity 0.1s;
        }
        .gantt-bar:hover { z-index: 50; transform: scaleY(1.05); opacity: 0.95; }
        
        .bar-phase { background-color: #134e4a; height: 10px; top: 15px; border-radius: 10px; }
        .bar-package { background-color: #059669; height: 10px; top: 15px; border-radius: 10px; }
        .bar-task { background-color: #3b82f6; }

        /* TIMELINE HEADER */
        .header-grid { display: grid; height: 100%; }
        .header-row-top { display: grid; height: 30px; line-height: 30px; border-bottom: 1px solid #e2e8f0; font-size: 0.8rem; font-weight: 600; color: #475569; background: #e2e8f0; }
        .header-row-bottom { display: grid; height: 30px; line-height: 30px; font-size: 0.75rem; color: #64748b; }
        .header-cell { text-align: center; border-right: 1px solid #e2e8f0; }
        
        /* TOOLTIP */
        .tooltip { position: fixed; background: #0f172a; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.75rem; pointer-events: none; opacity: 0; z-index: 100; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Header -->
        <header class="flex-shrink-0 mb-4 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Cronograma del Proyecto</h1>
            </div>
            <div class="flex flex-wrap gap-3 text-sm bg-white p-2 rounded-lg border border-slate-200 shadow-sm">
                <div class="flex items-center"><span class="w-3 h-3 bg-teal-900 rounded-full mr-2"></span><span class="font-medium text-slate-700">Fase</span></div>
                <div class="flex items-center"><span class="w-3 h-3 bg-emerald-600 rounded-full mr-2"></span><span class="font-medium text-slate-700">Paquete</span></div>
                <div class="flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span><span class="font-medium text-slate-700">Tarea</span></div>
            </div>
        </header>

        <!-- Gantt Component -->
        <div class="gantt-wrapper">
            <!-- 1. Header Row -->
            <div class="gantt-row-header">
                <div class="col-sidebar">
                    <div class="sidebar-title">Estructura del Proyecto</div>
                </div>
                <div class="col-chart">
                    <div id="timeline-header" class="timeline-header-scroll">
                        <!-- JS Injected -->
                    </div>
                </div>
            </div>

            <!-- 2. Body Row -->
            <div class="gantt-row-body">
                <div class="col-sidebar">
                    <div id="sidebar-list" class="sidebar-list">
                        <!-- JS Injected -->
                    </div>
                </div>
                <div class="col-chart">
                    <div id="chart-scroll-area" class="chart-scroll-area">
                        <div id="chart-content" class="grid-container">
                            <div id="grid-bg" class="grid-bg"></div>
                            <div id="bars-container" class="bars-layer"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Footer Row (Scroll Sync) -->
            <div class="gantt-row-footer">
                <div class="col-sidebar" style="border-right: 1px solid #e2e8f0;"></div>
                <div class="col-chart">
                    <div id="footer-scroll" style="overflow-x: auto; overflow-y: hidden; height: 100%;">
                        <div id="footer-scroll-content" style="height: 1px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <script>
        // Disable browser scroll restoration to ensure we start at 0
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }

        const rawData = [
            { name: '1. Caracterización del proceso y análisis exploratorio', type: 'phase', children: [
                { name: 'Levantamiento del proceso logístico', type: 'package', children: [
                    { id: 'T1', name: 'Revisión documental', start: '2025-01-06', end: '2025-01-08' },
                    { id: 'T2', name: 'Entrevistas con personal', start: '2025-01-08', end: '2025-01-10' },
                    { id: 'T3', name: 'Modelo AS-IS del proceso (BPMN)', start: '2025-01-10', end: '2025-01-13' },
                    { id: 'T4', name: 'Validación con expertos', start: '2025-01-13', end: '2025-01-14' },
                ]},
                { name: 'Priorización de insumos críticos', type: 'package', children: [
                    { id: 'T5', name: 'Revisión de registros', start: '2025-01-14', end: '2025-01-16' },
                    { id: 'T6', name: 'Análisis ABC multicriterio', start: '2025-01-16', end: '2025-01-19' },
                    { id: 'T7', name: 'Selección de insumos críticos', start: '2025-01-19', end: '2025-01-20' },
                ]},
                { name: 'Análisis exploratorio de datos (EDA)', type: 'package', children: [
                    { id: 'T8', name: 'Limpieza y normalización', start: '2025-01-20', end: '2025-01-23' },
                    { id: 'T9', name: 'Análisis estadístico', start: '2025-01-23', end: '2025-01-26' },
                    { id: 'T10', name: 'Selección de variables predictoras', start: '2025-01-26', end: '2025-01-28' },
                    { id: 'T11', name: 'Documentación del EDA', start: '2025-01-28', end: '2025-01-30' },
                ]},
            ]},
            { name: '2. Creación del modelo predictivo de riesgo', type: 'phase', children: [
                { name: 'Modelado y Experimentación', type: 'package', children: [
                    { id: 'T12', name: 'Configuración del entorno', start: '2025-01-30', end: '2025-01-31' },
                    { id: 'T13', name: 'Integración de fuentes', start: '2025-01-31', end: '2025-02-02' },
                    { id: 'T14', name: 'Creación del dataset', start: '2025-02-02', end: '2025-02-03' },
                    { id: 'T15', name: 'Modelos base', start: '2025-02-03', end: '2025-02-06' },
                    { id: 'T16', name: 'Configuración de experimentos', start: '2025-02-06', end: '2025-02-08' },
                    { id: 'T17', name: 'Entrenamiento de candidatos', start: '2025-02-08', end: '2025-02-11' },
                    { id: 'T18', name: 'Modelos transformados', start: '2025-02-11', end: '2025-02-14' },
                    { id: 'T19', name: 'Evaluación de métricas', start: '2025-02-14', end: '2025-02-17' },
                    { id: 'T20', name: 'Comparación de experimentos', start: '2025-02-17', end: '2025-02-19' },
                    { id: 'T21', name: 'Selección del modelo final', start: '2025-02-19', end: '2025-02-20' },
                ]}
            ]},
            { name: '3. Construcción del pipeline ETL/MLOps', type: 'phase', children: [
                { name: 'Ingesta y Transformación de Datos', type: 'package', children: [
                    { id: 'T22', name: 'Ajustes finales del dataset', start: '2025-02-20', end: '2025-02-22' },
                    { id: 'T23', name: 'Estructura de tablas y transformaciones', start: '2025-02-22', end: '2025-02-24' },
                    { id: 'T24', name: 'Definición del flujo EL/ETL', start: '2025-02-24', end: '2025-02-26' },
                    { id: 'T25', name: 'Desarrollo de tareas del pipeline', start: '2025-02-26', end: '2025-03-02' },
                    { id: 'T26', name: 'Pruebas de ejecución', start: '2025-03-02', end: '2025-03-04' },
                    { id: 'T27', name: 'Revisión de intermitencia', start: '2025-03-04', end: '2025-03-06' },
                    { id: 'T28', name: 'Carga de tablas finales', start: '2025-03-06', end: '2025-03-07' },
                ]},
                { name: 'Interpretabilidad y Validación', type: 'package', children: [
                    { id: 'T29', name: 'Interpretabilidad (importancia de variables)', start: '2025-03-14', end: '2025-03-17' },
                    { id: 'T30', name: 'Justificación del modelo', start: '2025-03-17', end: '2025-03-18' },
                    { id: 'T31', name: 'Validación adicional', start: '2025-03-18', end: '2025-03-20' },
                    { id: 'T32', name: 'Informe de validación', start: '2025-03-20', end: '2025-03-22' },
                    { id: 'T33', name: 'Revisión con expertos', start: '2025-03-22', end: '2025-03-23' },
                ]},
            ]},
            { name: '4. Desarrollo del DSS en Looker Studio', type: 'phase', children: [
                { name: 'Diseño del DSS', type: 'package', children: [
                    { id: 'T34', name: 'Definición de objetivos', start: '2025-03-23', end: '2025-03-24' },
                    { id: 'T35', name: 'Selección de KPIs', start: '2025-03-24', end: '2025-03-25' },
                    { id: 'T36', name: 'Diseño del prototipo', start: '2025-03-25', end: '2025-03-27' },
                ]},
                { name: 'Implementación y Simulación', type: 'package', children: [
                    { id: 'T37', name: 'Conexión a BigQuery', start: '2025-03-27', end: '2025-03-28' },
                    { id: 'T38', name: 'Construcción de visualizaciones', start: '2025-03-28', end: '2025-04-01' },
                    { id: 'T39', name: 'Validación de métricas', start: '2025-04-01', end: '2025-04-03' },
                    { id: 'T40', name: 'Definición de variables ajustables', start: '2025-04-03', end: '2025-04-04' },
                    { id: 'T41', name: 'Construcción del módulo de simulación', start: '2025-04-04', end: '2025-04-07' },
                    { id: 'T42', name: 'Integración al dashboard', start: '2025-04-07', end: '2025-04-09' },
                    { id: 'T43', name: 'Pruebas con expertos', start: '2025-04-09', end: '2025-04-11' },
                    { id: 'T44', name: 'Recolección de feedback', start: '2025-04-11', end: '2025-04-12' },
                    { id: 'T45', name: 'Correcciones', start: '2025-04-12', end: '2025-04-15' },
                ]}
            ]},
            { name: '5. Documentación y cierre', type: 'phase', children: [
                { name: 'Documentación Final', type: 'package', children: [
                    { id: 'T46', name: 'Integración de entregables', start: '2025-04-15', end: '2025-04-17' },
                    { id: 'T47', name: 'Capítulos finales', start: '2025-04-17', end: '2025-04-27' },
                    { id: 'T48', name: 'Anexos', start: '2025-04-27', end: '2025-05-01' },
                ]},
                { name: 'Cierre y Defensa', type: 'package', children: [
                    { id: 'T49', name: 'Revisión con asesor', start: '2025-05-01', end: '2025-05-02' },
                    { id: 'T50', name: 'Ajustes finales', start: '2025-05-02', end: '2025-05-04' },
                    { id: 'T51', name: 'Guion de exposición', start: '2025-05-04', end: '2025-05-06' },
                    { id: 'T52', name: 'PPT de defensa', start: '2025-05-06', end: '2025-05-09' },
                    { id: 'T53', name: 'Ensayo final', start: '2025-05-09', end: '2025-05-11' },
                    { id: 'T54', name: 'Entrega final', start: '2025-05-11', end: '2025-05-12' },
                ]}
            ]},
        ];

        // --- Logic ---
        
        function parseDate(str) {
            // Strict UTC parsing to avoid browser timezone offsets
            if (!str) return null;
            const [y, m, d] = str.split('-').map(Number);
            return new Date(Date.UTC(y, m - 1, d));
        }

        // Recursively calculate dates for groups
        function calcBounds(node) {
            if (!node.children) {
                node.dStart = parseDate(node.start);
                node.dEnd = parseDate(node.end);
                return;
            }
            
            let min = null;
            let max = null;
            node.children.forEach(child => {
                calcBounds(child);
                if (child.dStart && (!min || child.dStart < min)) min = child.dStart;
                if (child.dEnd && (!max || child.dEnd > max)) max = child.dEnd;
            });
            node.dStart = min;
            node.dEnd = max;
        }

        // --- Initialize App ---
        window.addEventListener('load', () => {
            
            // 1. Process Data
            rawData.forEach(calcBounds);
            
            const rows = [];
            let globalMin = null;
            let globalMax = null;

            rawData.forEach(phase => {
                rows.push({...phase, type: 'phase'});
                if(phase.children) {
                    phase.children.forEach(pkg => {
                        rows.push({...pkg, type: 'package'});
                        if(pkg.children) {
                            pkg.children.forEach(task => {
                                rows.push({...task, type: 'task'});
                            });
                        }
                    });
                }
            });

            // Find bounds
            rows.forEach(r => {
                if(r.dStart && (!globalMin || r.dStart < globalMin)) globalMin = r.dStart;
                if(r.dEnd && (!globalMax || r.dEnd > globalMax)) globalMax = r.dEnd;
            });

            // Safety check
            if(!globalMin) globalMin = new Date(Date.UTC(2025,0,1));
            if(!globalMax) globalMax = new Date(Date.UTC(2025,11,31));

            // Add Buffer
            const startDate = new Date(globalMin);
            startDate.setUTCDate(startDate.getUTCDate() - 3); // 3 days buffer start
            const endDate = new Date(globalMax);
            endDate.setUTCDate(endDate.getUTCDate() + 7); // 7 days buffer end

            // 2. Build Timeline
            const dayWidth = 40;
            const oneDay = 24*60*60*1000;
            const days = [];
            let curr = new Date(startDate);
            while(curr <= endDate) {
                days.push(new Date(curr));
                curr.setUTCDate(curr.getUTCDate() + 1);
            }

            const totalWidth = days.length * dayWidth;

            // DOM
            const headerEl = document.getElementById('timeline-header');
            const sidebarEl = document.getElementById('sidebar-list');
            const gridBgEl = document.getElementById('grid-bg');
            const barsEl = document.getElementById('bars-container');
            const chartContentEl = document.getElementById('chart-content');
            const footerContentEl = document.getElementById('footer-scroll-content');
            
            // Set Widths
            chartContentEl.style.width = `${totalWidth}px`;
            footerContentEl.style.width = `${totalWidth}px`;

            // Render Header & Grid
            const headerTop = document.createElement('div');
            headerTop.className = 'header-row-top';
            headerTop.style.gridTemplateColumns = `repeat(${days.length}, ${dayWidth}px)`;
            
            const headerBottom = document.createElement('div');
            headerBottom.className = 'header-row-bottom';
            headerBottom.style.gridTemplateColumns = `repeat(${days.length}, ${dayWidth}px)`;
            
            gridBgEl.style.gridTemplateColumns = `repeat(${days.length}, ${dayWidth}px)`;

            let lastMonth = '';
            let monthStart = 0;
            let monthCount = 0;

            days.forEach((d, i) => {
                // Bottom Header (Days)
                const dCell = document.createElement('div');
                dCell.className = 'header-cell';
                dCell.textContent = d.getUTCDate();
                headerBottom.appendChild(dCell);

                // Grid Lines
                const line = document.createElement('div');
                line.className = 'grid-line';
                const dayNum = d.getUTCDay();
                if(dayNum === 0 || dayNum === 6) line.classList.add('weekend');
                gridBgEl.appendChild(line);

                // Top Header (Months) logic
                const mLabel = d.toLocaleDateString('es-ES', {month:'long', year:'numeric', timeZone:'UTC'}).toUpperCase();
                if(mLabel !== lastMonth) {
                    if(lastMonth) {
                        const mCell = document.createElement('div');
                        mCell.className = 'header-cell';
                        mCell.style.gridColumn = `${monthStart+1} / span ${monthCount}`;
                        mCell.textContent = lastMonth;
                        headerTop.appendChild(mCell);
                    }
                    lastMonth = mLabel;
                    monthStart = i;
                    monthCount = 0;
                }
                monthCount++;
            });
            // Final month
            if(monthCount > 0) {
                const mCell = document.createElement('div');
                mCell.className = 'header-cell';
                mCell.style.gridColumn = `${monthStart+1} / span ${monthCount}`;
                mCell.textContent = lastMonth;
                headerTop.appendChild(mCell);
            }

            headerEl.appendChild(headerTop);
            headerEl.appendChild(headerBottom);

            // Render Rows & Bars
            rows.forEach((row, i) => {
                // Sidebar Row
                const rowEl = document.createElement('div');
                rowEl.className = `row-item type-${row.type}`;
                
                if(row.type === 'task') {
                    rowEl.innerHTML = `<strong>${row.id}</strong> ${row.name}`;
                } else {
                    rowEl.textContent = row.name;
                }
                sidebarEl.appendChild(rowEl);

                // Bar
                if(row.dStart && row.dEnd) {
                    const startDiff = (row.dStart - startDate) / oneDay;
                    const duration = (row.dEnd - row.dStart) / oneDay + 1;
                    
                    if(startDiff >= 0) {
                        const bar = document.createElement('div');
                        bar.className = `gantt-bar bar-${row.type}`;
                        bar.style.left = `${startDiff * dayWidth}px`;
                        bar.style.width = `${duration * dayWidth}px`;
                        bar.style.top = `${i * 40 + 8}px`; // 40px row height + 8px margin
                        
                        if(row.type !== 'task') {
                            bar.style.top = `${i * 40 + 15}px`;
                        }

                        if(row.type === 'task') {
                            bar.textContent = row.id;
                        }

                        // Tooltip events
                        bar.onmouseenter = (e) => showTooltip(e, row, duration);
                        bar.onmousemove = moveTooltip;
                        bar.onmouseleave = hideTooltip;

                        barsEl.appendChild(bar);
                    }
                }
            });

            // Set Heights
            const totalHeight = rows.length * 40;
            chartContentEl.style.height = `${totalHeight}px`;

            // --- Scroll Sync ---
            const scrollArea = document.getElementById('chart-scroll-area');
            const footerScroll = document.getElementById('footer-scroll');
            const sidebarList = document.getElementById('sidebar-list');

            scrollArea.onscroll = () => {
                headerEl.scrollLeft = scrollArea.scrollLeft;
                footerScroll.scrollLeft = scrollArea.scrollLeft;
                sidebarList.scrollTop = scrollArea.scrollTop;
            };

            footerScroll.onscroll = () => {
                scrollArea.scrollLeft = footerScroll.scrollLeft;
            };

            // Sidebar vertical scroll sync (optional if user scrolls sidebar)
            sidebarList.onscroll = () => {
                 scrollArea.scrollTop = sidebarList.scrollTop;
            };

            // Force Scroll Reset
            requestAnimationFrame(() => {
                scrollArea.scrollLeft = 0;
            });
        });

        // --- Tooltip Logic ---
        const tooltip = document.getElementById('tooltip');
        
        function showTooltip(e, row, days) {
            const s = row.dStart.toLocaleDateString('es-ES', {timeZone:'UTC'});
            const end = row.dEnd.toLocaleDateString('es-ES', {timeZone:'UTC'});
            
            tooltip.innerHTML = `
                <div style="font-weight:700; border-bottom:1px solid #334155; padding-bottom:4px; margin-bottom:4px">${row.name}</div>
                <div>Inicio: ${s}</div>
                <div>Fin: ${end}</div>
                <div>Duración: ${days} días</div>
            `;
            tooltip.style.opacity = 1;
            moveTooltip(e);
        }

        function moveTooltip(e) {
            tooltip.style.top = (e.clientY + 10) + 'px';
            tooltip.style.left = (e.clientX + 10) + 'px';
        }

        function hideTooltip() {
            tooltip.style.opacity = 0;
        }

    </script>
</body>
</html>
