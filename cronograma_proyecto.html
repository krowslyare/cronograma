<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama de Gantt - Cronograma de Proyecto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Layout Grid: Fixed Sidebar (500px) + Flexible Chart Area */
        .gantt-container { display: flex; flex-direction: column; height: 85vh; border: 1px solid #cbd5e1; border-radius: 0.5rem; overflow: hidden; background: white; }
        
        .gantt-header-row { display: flex; border-bottom: 1px solid #e2e8f0; background-color: #f1f5f9; flex-shrink: 0; }
        .gantt-body-row { display: flex; flex: 1; overflow: hidden; }
        .gantt-footer-row { display: flex; height: 20px; background-color: #f1f5f9; border-top: 1px solid #e2e8f0; flex-shrink: 0; }

        /* Sidebar (Task Names) */
        .sidebar-header { width: 500px; padding: 1rem; font-weight: 600; border-right: 1px solid #e2e8f0; flex-shrink: 0; display: flex; align-items: center; }
        .sidebar-body { width: 500px; overflow-y: hidden; border-right: 1px solid #e2e8f0; flex-shrink: 0; background-color: white; }
        
        /* Chart Area (Timeline) */
        .chart-header { flex: 1; overflow-x: hidden; position: relative; }
        .chart-body { flex: 1; overflow: auto; position: relative; scroll-behavior: smooth; } /* Main scroll area */
        .chart-footer { flex: 1; overflow-x: auto; overflow-y: hidden; } /* Sync scrollbar */

        /* Sync Scrollbar internals */
        .chart-footer-content { height: 1px; }

        /* Rows & Cells */
        .task-row { height: 40px; display: flex; align-items: center; border-bottom: 1px solid #e2e8f0; padding-right: 1rem; box-sizing: border-box; }
        .task-row:hover { background-color: #f8fafc; }
        
        /* Hierarchy Styling - FIXED COLORS TO MATCH LEGEND/BARS */
        /* Phase: Teal-900 (#134e4a) */
        .row-phase { background-color: #f0fdfa; color: #134e4a; font-weight: 700; padding-left: 1rem; border-bottom: 2px solid #134e4a; }
        /* Package: Emerald-600 (#059669) - Was Sky Blue previously */
        .row-package { background-color: #ecfdf5; color: #059669; font-weight: 600; padding-left: 2.5rem; }
        /* Task: Slate text, but ID will be Blue-500 (#3b82f6) */
        .row-task { padding-left: 4.5rem; color: #334155; font-size: 0.875rem; }
        .row-task strong { color: #3b82f6; } /* Link ID color to Bar color */

        /* Timeline Grid */
        .timeline-grid { display: grid; position: relative; }
        .header-months { display: grid; border-bottom: 1px solid #e2e8f0; height: 30px; line-height: 30px; font-weight: 600; font-size: 0.875rem; color: #475569; }
        .header-days { display: grid; height: 30px; line-height: 30px; font-size: 0.75rem; color: #64748b; }
        
        .header-cell { text-align: center; border-right: 1px solid #e2e8f0; overflow: hidden; white-space: nowrap; }
        .header-month-cell { text-align: center; border-right: 1px solid #cbd5e1; background: #e2e8f0; }
        
        .grid-background { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: grid; z-index: 0; pointer-events: none; }
        .grid-col { border-right: 1px solid #f1f5f9; height: 100%; }
        .weekend { background-color: #f8fafc; }

        /* Bars */
        .gantt-bar-container { position: relative; height: 100%; width: 100%; pointer-events: none; }
        .gantt-bar { position: absolute; height: 24px; top: 8px; border-radius: 4px; z-index: 10; pointer-events: auto; display: flex; align-items: center; padding: 0 0.5rem; font-size: 0.75rem; color: white; white-space: nowrap; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; transition: opacity 0.2s; }
        .gantt-bar:hover { opacity: 0.9; z-index: 20; }
        
        /* Bar Colors - MATCHED TO SIDEBAR */
        .bar-phase { background-color: #134e4a; height: 10px; top: 15px; border-radius: 5px; opacity: 0.8; }
        .bar-package { background-color: #059669; height: 10px; top: 15px; border-radius: 5px; opacity: 0.8; }
        .bar-task { background-color: #3b82f6; }

        /* Tooltip */
        .tooltip { position: fixed; background: #1e293b; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.75rem; pointer-events: none; opacity: 0; transition: opacity 0.1s; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 300px; }
    </style>
</head>
<body class="p-4 h-screen flex flex-col">
    
    <header class="mb-4 flex-shrink-0">
        <h1 class="text-2xl font-bold text-slate-800">Cronograma del Proyecto de Ciencia de Datos</h1>
        <div class="flex flex-wrap gap-4 mt-2 text-sm">
            <!-- Legend Colors (Tailwind classes matching CSS) -->
            <div class="flex items-center"><span class="w-3 h-3 bg-teal-900 rounded-sm mr-2"></span>Fase</div>
            <div class="flex items-center"><span class="w-3 h-3 bg-emerald-600 rounded-sm mr-2"></span>Paquete</div>
            <div class="flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-sm mr-2"></span>Tarea</div>
        </div>
    </header>

    <div class="gantt-container">
        <!-- Header: Task Names | Timeline Header -->
        <div class="gantt-header-row">
            <div class="sidebar-header">Tarea / Fase</div>
            <div class="chart-header" id="timeline-header">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- Body: Task Rows | Gantt Bars -->
        <div class="gantt-body-row">
            <div class="sidebar-body" id="task-list">
                <!-- Injected via JS -->
            </div>
            <div class="chart-body" id="chart-scroll-area">
                <div id="chart-content" class="relative">
                    <!-- Grid Background -->
                    <div id="grid-background" class="grid-background"></div>
                    <!-- Bars -->
                    <div id="bars-container" class="gantt-bar-container"></div>
                </div>
            </div>
        </div>
        
        <!-- Footer: Scroll Sync -->
        <div class="gantt-footer-row">
            <div style="width: 500px; border-right: 1px solid #e2e8f0; flex-shrink: 0;"></div>
            <div class="chart-footer" id="chart-footer-scroll">
                <div class="chart-footer-content" id="scroll-width-placeholder"></div>
            </div>
        </div>
    </div>

    <!-- Tooltip Element -->
    <div id="gantt-tooltip" class="tooltip"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. Data Definition ---
            // Using simple string dates. We will parse them strictly as UTC to avoid timezone shifts.
            const rawData = [
                { name: '1. Caracterización del proceso y análisis exploratorio', type: 'phase', children: [
                    { name: 'Levantamiento del proceso logístico', type: 'package', children: [
                        { id: 'T1', name: 'Revisión documental', start: '2025-01-06', end: '2025-01-08' },
                        { id: 'T2', name: 'Entrevistas con personal', start: '2025-01-08', end: '2025-01-10' },
                        { id: 'T3', name: 'Modelo AS-IS del proceso (BPMN)', start: '2025-01-10', end: '2025-01-13' },
                        { id: 'T4', name: 'Validación con expertos', start: '2025-01-13', end: '2025-01-14' },
                    ]},
                    { name: 'Priorización de insumos críticos', type: 'package', children: [
                        { id: 'T5', name: 'Revisión de registros', start: '2025-01-14', end: '2025-01-16' },
                        { id: 'T6', name: 'Análisis ABC multicriterio', start: '2025-01-16', end: '2025-01-19' },
                        { id: 'T7', name: 'Selección de insumos críticos', start: '2025-01-19', end: '2025-01-20' },
                    ]},
                    { name: 'Análisis exploratorio de datos (EDA)', type: 'package', children: [
                        { id: 'T8', name: 'Limpieza y normalización', start: '2025-01-20', end: '2025-01-23' },
                        { id: 'T9', name: 'Análisis estadístico', start: '2025-01-23', end: '2025-01-26' },
                        { id: 'T10', name: 'Selección de variables predictoras', start: '2025-01-26', end: '2025-01-28' },
                        { id: 'T11', name: 'Documentación del EDA', start: '2025-01-28', end: '2025-01-30' },
                    ]},
                ]},
                { name: '2. Creación del modelo predictivo de riesgo', type: 'phase', children: [
                    { name: 'Modelado y Experimentación', type: 'package', children: [
                        { id: 'T12', name: 'Configuración del entorno', start: '2025-01-30', end: '2025-01-31' },
                        { id: 'T13', name: 'Integración de fuentes', start: '2025-01-31', end: '2025-02-02' },
                        { id: 'T14', name: 'Creación del dataset', start: '2025-02-02', end: '2025-02-03' },
                        { id: 'T15', name: 'Modelos base', start: '2025-02-03', end: '2025-02-06' },
                        { id: 'T16', name: 'Configuración de experimentos', start: '2025-02-06', end: '2025-02-08' },
                        { id: 'T17', name: 'Entrenamiento de candidatos', start: '2025-02-08', end: '2025-02-11' },
                        { id: 'T18', name: 'Modelos transformados', start: '2025-02-11', end: '2025-02-14' },
                        { id: 'T19', name: 'Evaluación de métricas', start: '2025-02-14', end: '2025-02-17' },
                        { id: 'T20', name: 'Comparación de experimentos', start: '2025-02-17', end: '2025-02-19' },
                        { id: 'T21', name: 'Selección del modelo final', start: '2025-02-19', end: '2025-02-20' },
                    ]}
                ]},
                { name: '3. Construcción del pipeline ETL/MLOps', type: 'phase', children: [
                    { name: 'Ingesta y Transformación de Datos', type: 'package', children: [
                        { id: 'T22', name: 'Ajustes finales del dataset', start: '2025-02-20', end: '2025-02-22' },
                        { id: 'T23', name: 'Estructura de tablas y transformaciones', start: '2025-02-22', end: '2025-02-24' },
                        { id: 'T24', name: 'Definición del flujo EL/ETL', start: '2025-02-24', end: '2025-02-26' },
                        { id: 'T25', name: 'Desarrollo de tareas del pipeline', start: '2025-02-26', end: '2025-03-02' },
                        { id: 'T26', name: 'Pruebas de ejecución', start: '2025-03-02', end: '2025-03-04' },
                        { id: 'T27', name: 'Revisión de intermitencia', start: '2025-03-04', end: '2025-03-06' },
                        { id: 'T28', name: 'Carga de tablas finales', start: '2025-03-06', end: '2025-03-07' },
                    ]},
                    { name: 'Interpretabilidad y Validación', type: 'package', children: [
                        { id: 'T29', name: 'Interpretabilidad (importancia de variables)', start: '2025-03-14', end: '2025-03-17' },
                        { id: 'T30', name: 'Justificación del modelo', start: '2025-03-17', end: '2025-03-18' },
                        { id: 'T31', name: 'Validación adicional', start: '2025-03-18', end: '2025-03-20' },
                        { id: 'T32', name: 'Informe de validación', start: '2025-03-20', end: '2025-03-22' },
                        { id: 'T33', name: 'Revisión con expertos', start: '2025-03-22', end: '2025-03-23' },
                    ]},
                ]},
                { name: '4. Desarrollo del DSS en Looker Studio', type: 'phase', children: [
                    { name: 'Diseño del DSS', type: 'package', children: [
                        { id: 'T34', name: 'Definición de objetivos', start: '2025-03-23', end: '2025-03-24' },
                        { id: 'T35', name: 'Selección de KPIs', start: '2025-03-24', end: '2025-03-25' },
                        { id: 'T36', name: 'Diseño del prototipo', start: '2025-03-25', end: '2025-03-27' },
                    ]},
                    { name: 'Implementación y Simulación', type: 'package', children: [
                        { id: 'T37', name: 'Conexión a BigQuery', start: '2025-03-27', end: '2025-03-28' },
                        { id: 'T38', name: 'Construcción de visualizaciones', start: '2025-03-28', end: '2025-04-01' },
                        { id: 'T39', name: 'Validación de métricas', start: '2025-04-01', end: '2025-04-03' },
                        { id: 'T40', name: 'Definición de variables ajustables', start: '2025-04-03', end: '2025-04-04' },
                        { id: 'T41', name: 'Construcción del módulo de simulación', start: '2025-04-04', end: '2025-04-07' },
                        { id: 'T42', name: 'Integración al dashboard', start: '2025-04-07', end: '2025-04-09' },
                        { id: 'T43', name: 'Pruebas con expertos', start: '2025-04-09', end: '2025-04-11' },
                        { id: 'T44', name: 'Recolección de feedback', start: '2025-04-11', end: '2025-04-12' },
                        { id: 'T45', name: 'Correcciones', start: '2025-04-12', end: '2025-04-15' },
                    ]}
                ]},
                { name: '5. Documentación y cierre', type: 'phase', children: [
                    { name: 'Documentación Final', type: 'package', children: [
                        { id: 'T46', name: 'Integración de entregables', start: '2025-04-15', end: '2025-04-17' },
                        { id: 'T47', name: 'Capítulos finales', start: '2025-04-17', end: '2025-04-27' },
                        { id: 'T48', name: 'Anexos', start: '2025-04-27', end: '2025-05-01' },
                    ]},
                    { name: 'Cierre y Defensa', type: 'package', children: [
                        { id: 'T49', name: 'Revisión con asesor', start: '2025-05-01', end: '2025-05-02' },
                        { id: 'T50', name: 'Ajustes finales', start: '2025-05-02', end: '2025-05-04' },
                        { id: 'T51', name: 'Guion de exposición', start: '2025-05-04', end: '2025-05-06' },
                        { id: 'T52', name: 'PPT de defensa', start: '2025-05-06', end: '2025-05-09' },
                        { id: 'T53', name: 'Ensayo final', start: '2025-05-09', end: '2025-05-11' },
                        { id: 'T54', name: 'Entrega final', start: '2025-05-11', end: '2025-05-12' },
                    ]}
                ]},
            ];

            // --- 2. Robust Date Utilities (UTC Only) ---
            
            function parseDate(str) {
                // Input "YYYY-MM-DD" -> UTC Date Object at 00:00
                if(!str) return null;
                const parts = str.split('-');
                return new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
            }

            // Calculates min/max dates for Phase/Package based on children
            function calculateBounds(node) {
                if (!node.children || node.children.length === 0) {
                    node.startDate = parseDate(node.start);
                    node.endDate = parseDate(node.end);
                    return;
                }

                let min = null;
                let max = null;

                node.children.forEach(child => {
                    calculateBounds(child);
                    if (child.startDate) {
                        if (!min || child.startDate < min) min = child.startDate;
                    }
                    if (child.endDate) {
                        if (!max || child.endDate > max) max = child.endDate;
                    }
                });

                node.startDate = min;
                node.endDate = max;
            }

            // --- 3. Pre-process Data ---
            
            // Calculate hierarchy dates
            rawData.forEach(phase => calculateBounds(phase));

            // Flatten list for rendering rows
            const flattenedRows = [];
            rawData.forEach(phase => {
                flattenedRows.push({ ...phase, rowType: 'phase' });
                if(phase.children) {
                    phase.children.forEach(pkg => {
                        flattenedRows.push({ ...pkg, rowType: 'package' });
                        if(pkg.children) {
                            pkg.children.forEach(task => {
                                flattenedRows.push({ ...task, rowType: 'task' });
                            });
                        }
                    });
                }
            });

            // Find Global Min/Max for Timeline
            let globalStart = null;
            let globalEnd = null;

            flattenedRows.forEach(row => {
                if (row.startDate) {
                    if (!globalStart || row.startDate < globalStart) globalStart = row.startDate;
                }
                if (row.endDate) {
                    if (!globalEnd || row.endDate > globalEnd) globalEnd = row.endDate;
                }
            });

            // If no data, fallback
            if (!globalStart) globalStart = new Date(Date.UTC(2025, 0, 1));
            if (!globalEnd) globalEnd = new Date(Date.UTC(2025, 11, 31));

            // Buffer: Start 2 days before, End 7 days after
            const projectStartDate = new Date(globalStart);
            projectStartDate.setUTCDate(projectStartDate.getUTCDate() - 2);
            
            const projectEndDate = new Date(globalEnd);
            projectEndDate.setUTCDate(projectEndDate.getUTCDate() + 7);

            // --- 4. Render Logic ---

            const dayWidth = 40;
            const oneDay = 24 * 60 * 60 * 1000;
            
            // Generate Days Array
            const days = [];
            let curr = new Date(projectStartDate);
            while (curr <= projectEndDate) {
                days.push(new Date(curr));
                curr.setUTCDate(curr.getUTCDate() + 1);
            }
            
            const totalWidth = days.length * dayWidth;

            // DOM Elements
            const timelineHeader = document.getElementById('timeline-header');
            const taskList = document.getElementById('task-list');
            const barsContainer = document.getElementById('bars-container');
            const gridBackground = document.getElementById('grid-background');
            const scrollPlaceholder = document.getElementById('scroll-width-placeholder');

            // --- Render Timeline Header ---
            const monthHeader = document.createElement('div');
            monthHeader.className = 'header-months';
            monthHeader.style.width = `${totalWidth}px`;
            monthHeader.style.gridTemplateColumns = `repeat(${days.length}, ${dayWidth}px)`;

            const dayHeader = document.createElement('div');
            dayHeader.className = 'header-days';
            dayHeader.style.width = `${totalWidth}px`;
            dayHeader.style.gridTemplateColumns = `repeat(${days.length}, ${dayWidth}px)`;

            // Month aggregation
            let currentMonthLabel = '';
            let monthStartIndex = 0;
            let monthSpan = 0;

            days.forEach((day, index) => {
                // Day Cell
                const dCell = document.createElement('div');
                dCell.className = 'header-cell';
                dCell.textContent = day.getUTCDate();
                dayHeader.appendChild(dCell);

                // Grid Col
                const gCol = document.createElement('div');
                gCol.className = 'grid-col';
                const dayNum = day.getUTCDay();
                if (dayNum === 0 || dayNum === 6) gCol.classList.add('weekend');
                gCol.style.gridColumn = `${index + 1} / span 1`;
                gridBackground.appendChild(gCol);

                // Month Logic
                const mLabel = day.toLocaleDateString('es-ES', { month: 'long', year: 'numeric', timeZone: 'UTC' });
                if (mLabel !== currentMonthLabel) {
                    if (currentMonthLabel !== '') {
                        const mCell = document.createElement('div');
                        mCell.className = 'header-month-cell';
                        mCell.textContent = currentMonthLabel.toUpperCase();
                        mCell.style.gridColumn = `${monthStartIndex + 1} / span ${monthSpan}`;
                        monthHeader.appendChild(mCell);
                    }
                    currentMonthLabel = mLabel;
                    monthStartIndex = index;
                    monthSpan = 0;
                }
                monthSpan++;
            });
            // Final month
            if (monthSpan > 0) {
                const mCell = document.createElement('div');
                mCell.className = 'header-month-cell';
                mCell.textContent = currentMonthLabel.toUpperCase();
                mCell.style.gridColumn = `${monthStartIndex + 1} / span ${monthSpan}`;
                monthHeader.appendChild(mCell);
            }

            timelineHeader.appendChild(monthHeader);
            timelineHeader.appendChild(dayHeader);

            // Configure Grid Container
            gridBackground.style.width = `${totalWidth}px`;
            gridBackground.style.gridTemplateColumns = `repeat(${days.length}, ${dayWidth}px)`;
            scrollPlaceholder.style.width = `${totalWidth}px`;

            // --- Render Rows & Bars ---
            const rowHeight = 40;
            
            flattenedRows.forEach((row, rowIndex) => {
                // 1. Sidebar Row
                const taskDiv = document.createElement('div');
                taskDiv.className = `task-row row-${row.rowType}`;
                
                if (row.rowType === 'phase') {
                    taskDiv.textContent = row.name;
                } else if (row.rowType === 'package') {
                    taskDiv.textContent = row.name;
                } else {
                    taskDiv.innerHTML = `<strong class="mr-2">${row.id}</strong> ${row.name}`;
                }
                taskList.appendChild(taskDiv);

                // 2. Bar (if valid dates)
                if (row.startDate && row.endDate) {
                    const diffTime = row.startDate.getTime() - projectStartDate.getTime();
                    const startDayIndex = Math.floor(diffTime / oneDay);
                    
                    const durationTime = row.endDate.getTime() - row.startDate.getTime();
                    const durationDays = Math.floor(durationTime / oneDay) + 1; // Inclusive

                    if (startDayIndex >= 0) {
                        const bar = document.createElement('div');
                        bar.className = `gantt-bar bar-${row.rowType}`;
                        bar.style.left = `${startDayIndex * dayWidth}px`;
                        bar.style.width = `${durationDays * dayWidth}px`;
                        bar.style.top = `${(rowIndex * rowHeight) + 8}px`; // manual top positioning relative to container

                        // Specific Styling offsets
                        if (row.rowType !== 'task') {
                             bar.style.height = '10px';
                             bar.style.top = `${(rowIndex * rowHeight) + 15}px`;
                        }

                        // Label inside bar
                        if (row.rowType === 'task') {
                            bar.textContent = row.id; 
                        }

                        // Tooltip logic
                        bar.addEventListener('mouseenter', (e) => showTooltip(e, row));
                        bar.addEventListener('mouseleave', hideTooltip);
                        bar.addEventListener('mousemove', moveTooltip);

                        barsContainer.appendChild(bar);
                    }
                }
            });

            // Set content height
            const totalContentHeight = flattenedRows.length * rowHeight;
            document.getElementById('chart-content').style.height = `${totalContentHeight}px`;

            // --- Scroll Syncing ---
            const chartBody = document.getElementById('chart-scroll-area');
            const chartFooter = document.getElementById('chart-footer-scroll');
            const taskListBody = document.getElementById('task-list'); // Vertical sync for sidebar

            // Sync Horizontal
            chartBody.addEventListener('scroll', () => {
                timelineHeader.scrollLeft = chartBody.scrollLeft;
                chartFooter.scrollLeft = chartBody.scrollLeft;
                taskListBody.scrollTop = chartBody.scrollTop; // Sync vertical with sidebar
            });

            chartFooter.addEventListener('scroll', () => {
                chartBody.scrollLeft = chartFooter.scrollLeft;
            });
            
            // Sync Sidebar Vertical Scroll (if user scrolls sidebar)
            taskListBody.addEventListener('scroll', () => {
                 chartBody.scrollTop = taskListBody.scrollTop;
            });


            // --- Tooltip Logic ---
            const tooltipEl = document.getElementById('gantt-tooltip');

            function showTooltip(e, row) {
                const startStr = row.startDate.toLocaleDateString('es-ES', { timeZone: 'UTC' });
                const endStr = row.endDate.toLocaleDateString('es-ES', { timeZone: 'UTC' });
                const diffTime = row.endDate.getTime() - row.startDate.getTime();
                const days = (diffTime / oneDay) + 1;

                tooltipEl.innerHTML = `
                    <div class="font-bold border-b border-slate-600 pb-1 mb-1">${row.name}</div>
                    <div>Inicio: ${startStr}</div>
                    <div>Fin: ${endStr}</div>
                    <div>Duración: ${days} días</div>
                `;
                tooltipEl.style.opacity = '1';
                moveTooltip(e);
            }

            function moveTooltip(e) {
                const x = e.clientX + 15;
                const y = e.clientY + 15;
                tooltipEl.style.left = `${x}px`;
                tooltipEl.style.top = `${y}px`;
            }

            function hideTooltip() {
                tooltipEl.style.opacity = '0';
            }

            // --- FORCE RESET SCROLL ---
            // Critical fix for "middle of page" issue
            setTimeout(() => {
                chartBody.scrollLeft = 0;
                chartFooter.scrollLeft = 0;
                timelineHeader.scrollLeft = 0;
            }, 100);
        });
    </script>
</body>
</html>
